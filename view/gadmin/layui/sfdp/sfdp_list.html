{include file='common/head' /}
<style>
    .custom-table-content {
        float: none;
        display: flex;
        height: calc(100vh - 17px);
    }
    .selected{
        background:#e2e2e2; color:#666666;
    }
</style>
</head>
<body>
<div class="layui-fluid">
        <div class="layui-row layui-col-space15 custom-table-content">
            <div class="layui-col-md2" style="width: 13.66666667%;">
                <div class="layui-card" style="height: 100%">
                    <div class="layui-card-body" style="height: 100%;">
                        <span style="float: right;" onclick="layer_show('添加类别','/gadmin/Node/add.html?is_sfdp=1')"> 【新增】</span>
                        <div style="height: 100%;overflow-y: auto">
                            <ul id="test2" class=" demo-tree-box" style="height: 100%;"></ul>
                        </div>
                    </div>
                </div>
            </div>
    <div class="layui-col-md10" style="padding-left: 0px;width: 86.33333333%;" >
    <div class="layui-card">
        <div class="layui-card-body">
            <div class="layui-row flex-center" style="padding: 5px">
                <div class="layui-col-md6">
                    <a class="layui-btn layui-btn-sm g_tips layui-btn-primary" onClick=sfdp.openpage("创建",'{:url("sfdp_add")}')  data-tips="点击创建,可以创建业务信息">创建</a>
                    <a class="layui-btn layui-btn-sm  g_tips" data-tips="开始设计业务系统数据" id="design">设计</a>
                    <a class="layui-btn layui-btn-sm layui-bg-cyan g_tips" data-tips="统一为业务表单设计帮助引导信息" id="help">帮助</a>
                    <a class="layui-btn layui-btn-sm layui-bg-black g_tips" data-tips="设计业务表单打印信息" id="print">打印</a>
                    <ul class="layui-nav  layui-inline " lay-filter="demo" style="margin-left:10px;padding-left: 10px">
                        <li class="layui-nav-item">
                            <a href="javascript:;" class="layui-btn-sm">高级功能</a>
                            <dl class="layui-nav-child" style="top:35px">
                                <dd><a id="no"> 编码规则</a></dd>
                                <dd><a id="js"> 脚本设计</a></dd>
                                <dd><a id="event">事件管理</a></dd>
                                <dd><a id="source">元素构建</a></dd>
                                <dd><a id="desk"> 桌面组件</a></dd>
                                <dd><a id="flow">流程设计</a></dd>
                                <dd><a id="app">APP构建</a></dd>
                                <dd><a id="reset"> 一键重置</a></dd>
                                <dd><a id="data">数据构建</a></dd>
                                <dd><a id="dev">开发字段库</a></dd>
                                <dd><a id="key">索引构建</a></dd>
                                <dd><a onclick="add_btable()"> 黑名单表</a></dd>
                                <dd><a id="extend_plug"> 导出脚本</a></dd>
                                <dd><a id="del_all"> 彻底删除</a></dd>
                            </dl>
                        </li>
                    </ul>
                </div>
                <div class="layui-col-md6 align-right">
                    <div class="layui-inline">
                        <form action="" method="post" name="form" id="form">
                            <div class="layui-inline">
                                <label class="layui-form-label">
                                    筛选条件：
                                </label>
                                <div class="layui-input-inline" >
                                    <div class="layui-input-inline">
                                        <input name="sids" id="show_field" type="hidden">
                                        <input class="input-text layui-input" value="{$_POST['s_title'] ?? ''}" placeholder="业务名称" style="width:auto" id="s_title" name="s_title" type='text'>
                                    </div>
                                    <div class="layui-input-inline">
                                        <input class="input-text layui-input" value="{$_POST['s_db'] ?? ''}" placeholder="表名" style="width:auto" name="s_db" id="s_db" type='text'>
                                    </div>
                                    <div class="layui-input-inline">
                                        <button class="layui-btn  layui-btn-sm layui-btn-primary" id='searchsubmit'><i class="layui-icon layui-icon-search" ></i></button>
                                        <a class="layui-btn layui-btn-sm "onClick=g_help('sfdp') style="display: none"><i class="layui-icon layui-icon-help"></i></a>
                                    </div>
                                </div>
                            </div>
                        </form>

                    </div>
                </div>
            </div>
            <table lay-filter="parse-table-demo" class="layui-table" lay-data="{id: 'idData'}" id="tabledata">
                <thead>
                <tr class="text-c">
                    <th lay-data="{field:'id',type:'radio'}"></th>
                    <th lay-data="{field:'id',width:55,align: 'center'}">sid</th>
                    <th lay-data="{field:'s_bill',width:150,align: 'center'}">设计编号</th>
                    <th lay-data="{field:'s_title',width:280}">业务名称</th>
                    <th lay-data="{field:'s_db',width:140}">表名</th>
                    <th lay-data="{field:'is_wf',width:100,align: 'center'}">工作流</th>
                    <th lay-data="{field:'s_type',width:100,align: 'center'}">表单类型</th>
                    <th lay-data="{field:'add_time',width:120,align: 'center'}">设计时间</th>
                    <th lay-data="{field:'s_design',width:90,align: 'center'}">启用状态</th>
                    <th lay-data="{field:'s_look',width:90,align: 'center'}">锁定状态</th>
                    <th lay-data="{field:'bton',align: 'left'}">操作</th>
                </tr>
                </thead>
                {volist name='list' id='k'}
                <tr class="text-c">
                    <td >{$k.id}</td>
                    <td >{$k.id}</td>
                    <td >{$k.s_bill}</td>
                    <td>{$k.s_title}</td>
                    <td >{$k.s_db}</td>
                    <td id="{$k.is_wf}">{eq name='k.is_wf' value='1'}<font color="#6495ed">是</font>{else/}否{/eq}</td>
                    <td>
                        <input id="s_type_{$k.id}" value="{$k.s_type}" type="hidden">
                        {eq name='k.s_type' value='0'}
                        <span class="layui-badge-dot layui-bg-blue" ></span> 业务表单
                        {/eq}
                        {eq name='k.s_type' value='1'}
                            <span class="layui-badge-dot layui-bg-yellow"></span> 编辑表单
                        {/eq}
                        {eq name='k.s_type' value='2'}
                            <span class="layui-badge-dot layui-bg-blue"></span> 数据表单
                        {/eq}
                        {eq name='k.s_type' value='3'}
                        <span class="layui-badge-dot layui-bg-cyan"></span> 列表表单
                        {/eq}
                    </td>
                    <td>{$k.add_time|date='Y-m-d'}</td>
                    <td>
                        {if condition='($k.s_design == "0")or($k.s_design == "1")'}
                        <span class="layui-badge-dot layui-bg-red" ></span> 未部署
                          {else/}
                        <span class="layui-badge-dot layui-bg-blue" ></span> 已部署
                        {/if}
                    </td>
                    <td>{eq name='k.s_look' value='0'}
                        <span class="layui-badge-dot layui-bg-red" ></span> 未锁定
                        {else/}
                        <span class="layui-badge-dot layui-bg-blue" ></span> 锁定

                        {/eq}</td>
                    <td>
                        <div class="layui-btn-group">
                            {}
                        {if condition='$k.s_field <> 1'}
                            {in name=":session('softId')" value=":g_cache('sfdp_fix')"}
                            <a onClick=sfdp.Askshow("{$urls}?act=fix&sid={$k['id']}","【部署】删除所有数据，并生成最新的版本,确定是否执行?") class="btn radius size-S" style="color: #5e7ce0;">部署</a>
                            {/in}
                            {if condition='$k.s_look == 1'}
                            <a onClick=sfdp.Askshow("{$urls}?act=fix2&sid={$k['id']}","【更新】对布局或字段进行细微调整,确定是否执行?")  class="btn radius size-S" style="color: #5e7ce0;">更新</a>
                            {/if}
                        <a onClick=sfdp.openpage("定义管理——{$k['s_bill']}","{$urls}?act=custom&sid={$k['id']}") class="btn radius size-S" style="color: #5e7ce0;">定义</a>
                        {/if}
                            {in name=":session('softId')" value=":g_cache('sfdp_db')"}
                                {if condition='$k.s_db_bak == 1'}
                                 <a onClick=sfdp.Askshow("{$urls}?act=deldb&sid={$k['id']}","删除备份数据库,是否执行?")  class="btn radius size-S" style="color: #5e7ce0;">删表</a>
                                {/if}
                            {/in}
                        </div>
                    </td>
                </tr>
                {/volist}
            </table>
        </div>
        <div class="layui-col-md12">
            <div class="layui-card">
                <div class="layui-card-body">
                    <blockquote class="layui-elem-quote layui-text" style="border-left: 5px solid #960000;">
                        <p>帮助：</p>
                        <p>【打印模板】自定义页面套打模板，可以对需要的业务进行打印设置</p>
                        <p>【部&emsp;&emsp;署】对设计的数据进行全新部署,<b style="color: #A60000">会删除业务数据，需要手动重新导入数据！</b></p>
                        <p>【更&emsp;&emsp;新】对设计布局，设计字段，简单调整</p>
                        <p>【删&emsp;&emsp;表】删除当前备份的数据表 如 news_bak</p>
                    </blockquote>
                </div>
            </div>
        </div>
    </div>
</div></div>
{include file='common/footer' /}
<script src="__SFDP__/sfdp.7.0.js"></script>
<script>
    layui.use('table', function(){
         var table = layui.table;
        table.init('parse-table-demo', {
            limit:16,
            escape:false,
            limits:[16,30,50,100,200],
            page: true,
            height: 'full-267'
        });
        table.on('row(parse-table-demo)', function(obj){
            obj.tr.find('i[class="layui-anim layui-icon layui-icon-circle"]').trigger("click");
        });
        $("#design").click(function (ev) {
            window.top.close_cb();
            sfdp.openfullpage("业务设计","{$urls}?act=center&sid="+get_id());
        });
        $("#help").click(function () {
            sfdp.openfullpage("帮助系统","{:url('help')}?sid="+get_id());
        });
        $("#del_all").click(function () {
            layer.confirm("请再次确认是否彻底删除，彻底删除前请先做好数据备份；<font color='red'>十分危险的操作！</font>;此操作只会删除设计数据，布局数据，实体数据表，不会被系统删除！", function (index) {
                var url = "{:url('sfdp_del')}?id="+get_id();
                sfdp.Askshow(url,"再次确认是否删除,是否执行?无法回退，请做好备份！");
            });
        });
        $("#print").click(function () {
            sfdp.openfullpage("打印设计","{:url('print')}?sid="+get_id());
        });
        $("#js").click(function () {
            sfdp.openfullpage("脚本系统","/gadmin/sfdp/sfdpApi.html?act=script&sid="+get_id());
        });
        $("#no").click(function () {
            sfdp.openfullpage("编码规则","{:url('no')}");
        });
        $("#key").click(function () {
            sfdp.openfullpage("索引方法","/gadmin/sfdp/sfdpApi.html?act=fieldkey&sid="+get_id(),{w: "38%", h: "38%"});
        });
        $("#node").click(function () {
            add_fun(get_id())
        });
        $("#source").click(function () {
            layer.confirm("请确认是否自动构建元素？", function (index) {
                var url = "{:url('sfdp_source')}?sid="+get_id();
                sfdp.Askshow(url,"再次确认是否自动构建元素！");
            });
        });
        $("#extend_plug").click(function () {
            layer.confirm("请确认导出设计脚本？", function (index) {
                layer.msg('操作成功！');layer.close();
                window.location.href = "{:url('extend_plug')}?id="+get_id();

            });
        });

        $("#reset").click(function () {
            layer.confirm("请确认是否一键重置<font color='red'>【适用于删除日志，审批记录】</font>等相关操作？", function (index) {
                var url = "{:url('sfdp_reset')}?sid="+get_id();
                sfdp.Askshow(url,"再次确认是否一键重置，<font color='red'>删除后数据无法恢复！如果有运行流程，可能导致流程出错！！！！！！</font>");
            });
        });
        $("#app").click(function () {
            var url = "{:url('app/buildapp')}?sid="+get_id();
            layer.confirm("请确认是否部署APP，如果部署，系统会自动开启APP功能；<font color='red'>已有数据会被系统更新！</font>", function (index) {
                $.get(url, function (data, status) {
                    if (status === 'success') {
                        if (data.code === 0) {
                            layer.msg(data.msg);
                        }else if(data.code === 1){
                            layer.alert(data.msg, {title: "错误信息", icon: 2});
                        }else{
                            layer.alert(data, {title: "错误信息", icon: 2});
                        }
                    } else {
                        layer.alert("状态: " + status, {title: "错误信息", icon: 2});
                    }
                });
            });
        });
        $("#flow").click(function(){
            var checkStatus = table.checkStatus('idData'); //获取选中行状态
            var data = checkStatus.data;  //获取选中行数据
            if(data==''){
                layer.msg('请选中要设计流程的业务！');
                return false;
            }
            if(data[0].is_wf=='否'){
                layer.msg('单据未开启流程引擎！！');
                return false;
            }
            sfdp.openpage("流程设计",'{:url("sfdp_wf")}?db='+data[0].s_db)
        });
        $("#event").click(function(){
            sfdp.openfullpage("单据事务",'{:url("event")}?sid='+get_id())
        });
        $("#dev").click(function(){
            sfdp.openpage("单据事务",'{:url("sfdp_field")}?sid='+get_id(),{w: "58%", h: "58%"})
        });


        $("#desk").click(function (){
            layer.confirm('您可以在这里快速创建一个桌面组件模板，创建后可在桌面组件中进行美化数据调整！', {
                title:'桌面帮助',
                area: ['430px', '195px'],
                btn: ['卡片', '列表', '仪表盘', '水波图', '更多...'] //可以无限个按钮
                ,btn3: function(){
                    var url = "{:url('sfdp_build')}?sid="+get_id()+"&type=2";
                    sfdp.Askshow(url,"确认创建一个仪表盘demo！");
                },btn4: function(){
                    var url = "{:url('sfdp_build')}?sid="+get_id()+"&type=3";
                    sfdp.Askshow(url,"确认创建一个水波图demo！");
                },
                btn5: function(){
                    window.parent.openUrl('桌面配置','{:url("sys/desk")}')
                }
            }, function(){
                var url = "{:url('sfdp_build')}?sid="+get_id()+"&type=0";
                sfdp.Askshow(url,"确认创建一个桌面快捷菜单！");
            }, function(index){
                var url = "{:url('sfdp_build')}?sid="+get_id()+"&type=1";
                sfdp.Askshow(url,"确认创建一个桌面列表！");
            });

        });
        $("#data").click(function(){
            var checkStatus = table.checkStatus('idData'); //获取选中行状态
            var data = checkStatus.data;  //获取选中行数据
            if(data==''){
                layer.msg('请选中要操作的业务的业务！');
                return false;
            }
            if($('#s_type_'+data[0].id).val() !=2){
                layer.msg('非数据表单！');
                return false;
            }
            sfdp.openpage("单据事务",'{:url("data")}?sid='+data[0].id)
        });
        function get_id(){
            var checkStatus = table.checkStatus('idData'); //获取选中行状态
            var data = checkStatus.data;  //获取选中行数据
            if(data==''){
                layer.msg('请选中要操作的业务的业务！');
                throw SyntaxError();
            }
            return data[0].id;
        }
    });
    function add_fun(sid){
        var htmls = '<div style="margin:10px;">节点：<select id="nodesss"  style="width: 60%" ><option value="">请选择挂带节点</option>{$Node['html']|raw}</select>　<a onClick=getmenu('+sid+')  class="layui-btn layui-btn-sm layui-btn-danger">创建节点</a></div>';
        layer.open({
            title: '选择挂带节点信息',
            type: 1,
            area: ['520px', '150px'], //宽高
            content: htmls
        });
    }
    function add_btable(){
        layer.open({
            type: 1,
            title:'创建黑名单表',
            area: ['320px', '280px'], //宽高
            content: '<table class=layui-table id="table_view"><tr><td>表名称</td><td style="text-align:left"><input type="text" id="title"></td></tr>'+
                '<tr><td>表别名</td><td style="text-align:left"><input type="text" id="name" ></td></tr>'+
                '<tr><td colspan=2 style="text-align: center;"><a class="layui-btn layui-btn-sm  layui-btn-primary" onclick="save_btable()">提交</a></td></tr><tr><td colspan=2>*黑名单表是为了防止重复而设计；<br/>*表名称：不含表前缀；如：sfdp_table<br/>表别名：如新闻信息表</td></tr></table>'
        });
    }
    function save_btable(){
        var title = $('#title').val();
        var name = $('#name').val();
        if(title =='' || name==''){
            sfdp.ShowTip('表名称和内容必须填写！');
            return;
        }
        var url = "{$urls}?act=btable";
        sfdp.sAjax(url,{title:title,name:name});
    }
    function getmenu(sid){
        var node = $('#nodesss').val();
        if(node==''){
            sfdp.ShowTip('请选择节点信息！');
            return;
        }
        var url = "{$urls}?act=node&sid="+sid+"&node="+node;
        sfdp.Askshow(url,"再次确认是否创建目录,是否执行?");
    }
    localStorage.removeItem('json_data');//清空设计数据，减少干扰

</script>
    <script>
        layui.use(['tree', 'util'], function () {
            var tree = layui.tree
            //仅节点左侧图标控制收缩
            tree.render({
                    elem: '#test2'
                    ,data: {$tree|raw}
                ,spread: true
                , onlyIconControl: true  //是否仅允许节点左侧图标控制展开收缩
                , click: function (obj) {
                        console.log(obj);
                if(obj.data.id==1){
                    $('#show_field').val('');
                }else{
                    $('#show_field').val(obj.data.sid);
                }
                $('.layui-tree-set').removeClass('selected');
                obj.elem.addClass('selected');
                $('#searchsubmit').click();
            }
        });

        });
    </script>
</body>
</html>
