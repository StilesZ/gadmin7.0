<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="renderer" content="webkit|ie-comp|ie-stand" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
    <meta http-equiv="Cache-Control" content="no-siteapp" />
    <title></title>
    <link rel="stylesheet" href="__SFDP__/sfdp.7.0.css?v=7.0.0" />
    <link rel="stylesheet" href="/static/layui/css/layui.css" />
    <link rel="stylesheet" href="__LIB__/select2/select2.min.css" />
    {$config.load_file.css|raw}
    <style>
        .layui-form-label {
            border-left: 3px solid #009688e8 !important;
            background-color: white !important;
        }
        #uploadInfo{
            background-color: white !important;
            border: 1px solid #2d6dcc !important;
            color: #2d6dcc !important;
        }
        .save-btn{
            background-color: white !important;
            border: 1px solid #2d6dcc !important;
            color: #2d6dcc !important;
        }
        .layui-input-block{
            display: flex;
            align-items: center;
        }
        .select2-container .select2-selection--multiple{
            height: 38px;
            border: 1px solid rgb(204, 204, 204);
            border-radius: 0px;
        }
        .select2-container--default .select2-selection--single{
            height: 38px;
            border: 1px solid rgb(204, 204, 204);
            border-radius: 0px;
        }
        .select2-container--default .select2-selection--single .select2-selection__rendered {
            line-height: 38px;
        }
        .select2-container--default .select2-selection--multiple .select2-selection__choice{
            border-radius: 0px;
            height: 23px;
        }
    </style>
</head>
<body>
<!--加载全局变量函数-->
{$config.g_js|raw}
<ul class="layui-nav">
    <li class="layui-nav-item"> {:g_cache('sysname')} {:g_cache('sysv')} · {$title}</li>
</ul>
<div class="layui-card">
    <div class="layui-card-body">
        {$content|raw}
    </div>
</div>
<div class="page-container"><div class="tpfd-content" id='table'></div></div>
<script src="__SFDP__/lib/jquery-3.4.1.min.js"></script>
<script src="__SFDP__/lib/jquery-ui.js"></script>
<script src="__SFDP__/lib/layer/3.1.1/layer.js"></script>
<script src="__LIB__/Validform/5.3.2/Validform.min.js"></script>
<script src="__SFDP__/lib/H5upload.js"></script>
<script src="__SFDP__/lib/laydate5.0.9/laydate.js"></script>
<script src="__SFDP__/sfdp.7.0.js?v=7.0.1"></script>
<script src="__SFDP__/sfdp.config.js?v=7.0.1"></script>
<script src="__SFDP__/sfdp.plug.js?v=7.0.1"></script>
<script src="__LIB__/select2/select2.min.js?v=7.0.1"></script>
<script src="/static/common.js?v=7.0.1"></script>
{$config.load_file.js|raw}
<script>
    $("head").append(sfdp.ui.ui_css);
</script>
<!--动态加载用户自定义脚本-->
{$config.fun|raw}
<!--脚本结束-->
<script>
    var g_bill_id = '{$id ?? ""}';
    var showtype = '{$showtype}';
    var s_type = '{$config["s_type"]}';
    var uploadurl = '{:url($config["upload_file"])}';
    try{
        load_satr_fun(showtype);//后置函数
    }catch(e){
    }
    $( function() {
        sfdp.showadd({$data|raw},showtype);
        $('.this-select').select2({width:'100%'});
        $("#form").Validform({
            tiptype:function(msg,o,cssctl){
                if (o.type == 3){
                    layer.msg(msg, {time: 800});
                }
            },
            beforeCheck:function(curform){
                try{
                    return load_form_check(curform);//后置函数
                }catch(e){
                    if(Debug){
                        console.log('表单验证后，进行验算');
                    }
                }
            },
            ajaxPost:true,
            showAllError:false,
            callback:function(data){
                if (data.code === 0) {
                    layer.msg(data.msg, {icon: 1, time: 1500}, function () {
                        location.href = '/api/data/jump';
                    });
                } else {
                    layer.alert(data.msg || data.responseJSON.message, {title: "错误信息", icon: 2});
                }
            }
        });
        $(".savedata").click(function(){
            /*构建子表json*/
            var searchdata = [];
            var stable = [];
            var allSdata = {};
            /*遍历找出所有子表*/
            $(".sub_list").each(function(index, el) {
                var id = $(this).attr("data");
                if(typeof(id)!=='undefined'){
                    stable.push(id)
                }
            });
            //遍历子表，找出子表的表单数据
            $.each(stable, function(index,table) {
                var search = $('#'+table).serializeArray();
                //表单数据拼接成数组
                var i = 0;
                $.each(search, function(index,vars) {
                    var dbname = this.name;
                    if(searchdata[dbname] == undefined){
                        searchdata[dbname] = [];
                        searchdata[dbname].push(vars.value || '');
                    }else{
                        searchdata[dbname].push(vars.value);
                    }
                });
                allSdata[table] = {};
                allSdata[table] = Object.assign({},searchdata);
                searchdata = [];
            });
            $('#subdata_subdata').val(JSON.stringify(allSdata));
            $("#form").submit();
        });
    });
    $(document).on("input propertychange", "#row-title", function (e) {
        var title = $('#row-title').val();
        var p_id = $('#row-id').val();
        $('#' + p_id + '_title').html(title);
        sfdp.dataSave(title, p_id, 'sublist_title');
    });
    $('body').on('input propertychange', ".this-select", function(event) {
        var is_dx = $(this).attr("multiple");
        if(is_dx !=undefined){
            var o=document.getElementById($(this).attr("id")).getElementsByTagName('option');
            var all="";
            console.log(o[1]);
            for(var i=0;i<o.length;i++){
                if(o[i].selected){
                    all+=o[i].value+",";
                }
            }
           document.getElementById($(this).attr("id")+'_val').value = all.substr(0, all.length - 1);
        }
    });
    $(document).ready(function(){
        try{
            load_end_fun(showtype);//后置函数
        }catch(e){
        }
    });
</script>
</body>
</html>
