<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Fkreport - 企业级报表开发平台</title>
</head>
<body>
<link href="/static/layui/css/layui.css" rel="stylesheet">
<link href="/static/fk/plugins/css/pluginsCss.css" rel="stylesheet"/>
<link href="/static/fk/plugins/plugins.css" rel="stylesheet"/>
<link href="/static/fk/css/luckysheet.css" rel="stylesheet"/>
<link href="/static/fk/css/app.css" rel="stylesheet"/>
<link href="/static/fk/css/iconfont/iconfont.css" rel="stylesheet"/>

<script src="/static/fk/jquery-2.1.0.min.js"></script>
<script src="/static/fk/plugins/js/plugin.js"></script>
<script src="/static/fk/luckysheet.umd.js"></script>
<script src="/static/fk/fk1.0.js"></script>
<script src="/static/layui/layui.all.js"></script>
<h2 class="titles">
    Fkreport - 企业级报表开发平台
</h2>
<div class="all-content">
    <div class="left-content">
        <ul class="layui-nav layui-nav-tree layui-inline" style="margin-right: 10px;">
            <li class="layui-nav-item layui-nav-itemed" id="field">
            </li>
        </ul>
        <i class="layui-icon layui-icon-addition" style="font-size: 45px;color: #1E9FFF;float: left;width: 100%;background: #fff;margin-bottom: 5px;bottom: 40px;left: 35px;position: absolute;font-weight: 800;" onclick=Fkreport.layer_open('{:url('fk/api')}?act=edit&id={$id}')></i>
        <i class="layui-icon layui-icon-play" style="font-size: 45px;color: #1E9FFF;float: left;width: 100%;background: #fff;margin-bottom: 5px;bottom: 40px;left: 110px;position: absolute;font-weight: 800;" onclick="save()"></i>
    </div>
    <div id="luckysheet">

    </div>
    <div class="right-content">
        <ul class="layui-nav layui-nav-tree layui-inline" lay-filter="demo" style="margin-right: 10px;">
            <li class="layui-nav-item layui-nav-itemed">
                <a href="javascript:">属性栏目</a>
                <dl class="layui-nav-child">
                    <dd class="choose-text"></dd>

                </dl>
            </li>
        </ul>
    </div>
</div>
<div class="textmove"></div>
</body>
<script>
    const Fk_id = {$id};
    const server_url = "{:url('fk/api')}?act=save&id="+Fk_id;
    var server_data = {$data.data.data|raw};
    var server_fun = `{$data.data.fun}`;
    if({$data.data.data|raw}==1){
         var server_data = [{
             "name": "Fkreport报表系统",
             "index": "sheet_01",
             "order":  0,
             "status": 1,
             "celldata": []
         }];
    }
    $(function () {
        var movelock = false
        var options = {
            container: 'luckysheet',
            lang: 'zh',
            allowEdit: true,
            celldata:server_data,
            showinfobar: false,
            showtoolbarConfig:{
                image: false,
                print: false,
                link:false,
                findAndReplace: false,
                protection:false,splitColumn: false,screenshot: false
            },
            hook: {
                sheetMouseup: (tabl, nowData) => {
                    console.log(nowData)
                    var text = $(".textmove").html()
                    if (text) {
                        luckysheet.setCellValue(nowData.r, nowData.c, `#{'${text}','${server_fun}'}`);
                        $(".textmove").html("")
                    }
                }
            },
            data:server_data
        }
        luckysheet.create(options)
        $("body").mousemove(function (e) {  //
            if (!movelock) {
                return
            }
            var x = e.pageX
            var y = e.pageY
            $(".textmove").css({
                top: y - 10 + 'px',
                left: x - 10 + 'px'
            })
        })
        $(".textmove").mouseup(function () { //鼠标松开
            movelock = false
            $(".textmove").hide()

        })
        $("#field").on("mousedown", ".choose-text", function () {
            movelock = true
            $(".textmove").show().text($(this).html())
        });
    })
    function save(){
        var excel = luckysheet.getAllSheets();
        $.ajax({
            url: server_url,
            data: {data: JSON.stringify(excel)},
            type: 'post',
            cache: true,
            dataType: 'json',
            success: function (ret) {
                if (ret.code !== 0) {
                    layer.alert(ret.msg, {title: "错误信息", icon: 2});
                }else{
                    layer.msg('保存成功！');
                }
            },
            error: function () {
                layer.alert('请求出错！', {title: "错误信息", icon: 2});
            }
        });

    }
    if(server_fun != ''){
        sFun();
    }

    function sFun() {
        $.ajax({
            url: `/gadmin/report/sapi`,
            data: {'fun':'@'+server_fun,'Type':'bar','Id':'bar'},
            type: 'post',
            dataType: 'json',
            success: function (ret) {
                var Html = `<a href="javascript:">${server_fun}</a><dl class="layui-nav-child">`;
                $.each(ret.field, function(index, value) {
                    console.log(value);
                    Html +=`<dd class="choose-text">${value}</dd>`;
                });
                Html +=`</dl>`;
                $('#field').append(Html);
            },
            error: function () {
                layer.alert('请求出错！', { title: "错误信息", icon: 2 });
            }
        });
    }
</script>
</body>

</html>